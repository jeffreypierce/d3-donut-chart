var DonutChart=function(selector,data,config){if(!selector)throw"Please provide a selector";var _donutChart=this,settings=function(){var defaults={width:450,height:300,radius:100,innerRadius:70,strokeColor:"#FFF",strokeWidth:5,enableLabels:!0,labelGroupOffset:20,labelColor:"#333",labelValueText:function(arc){return Math.floor(arc.value/_donutChart.totals*100)+"%"},labelValueOffset:16,labelNameText:function(arc){return arc.name+" ("+arc.value+")"},labelNameOffset:0,tickColor:"#333",tickWidth:1,tickOffset:[0,0,2,8],easeFunction:"cubic",animationDuration:250,colors:d3.scale.category20()};for(var item in config)defaults[item]=config[item];return defaults}();this.currentData=[],this.oldData=[];var calculateAngles=function(start,end){var _this=this,interpolate=d3.interpolate({startAngle:start,endAngle:end},{startAngle:_this.startAngle,endAngle:_this.endAngle});return function(t){var b=interpolate(t);return arc(b)}},chartTween=function(d,i){var start=0,end=0,oldData=_donutChart.oldData;return oldData[i]?(start=oldData[i].startAngle,end=oldData[i].endAngle):!oldData[i]&&oldData[i-1]?(start=oldData[i-1].endAngle,end=oldData[i-1].endAngle):!oldData[i-1]&&oldData.length>0&&(start=oldData[oldData.length-1].endAngle,end=oldData[oldData.length-1].endAngle),calculateAngles.call(d,start,end)},removeChartTween=function(d){var start=2*Math.PI,end=2*Math.PI;return calculateAngles.call(d,start,end)},textTween=function(d,i){var b,fn,a=0,oldData=_donutChart.oldData;return oldData[i]?a=(oldData[i].startAngle+oldData[i].endAngle-Math.PI)/2:!oldData[i]&&oldData[i-1]?a=(oldData[i-1].startAngle+oldData[i-1].endAngle-Math.PI)/2:!oldData[i-1]&&oldData.length>0&&(a=(oldData[oldData.length-1].startAngle+oldData[oldData.length-1].endAngle-Math.PI)/2),b=(d.startAngle+d.endAngle-Math.PI)/2,fn=d3.interpolateNumber(a,b),function(t){var val=fn(t);return"translate("+Math.cos(val)*(settings.radius+settings.labelGroupOffset)+","+Math.sin(val)*(settings.radius+settings.labelGroupOffset)+")"}},positionLabels=function(offset){var _position=function(){this.attr("dy",function(){return offset}).attr("text-anchor",function(d){return(d.startAngle+d.endAngle)/2<Math.PI?"beginning":"end"})};return _position.call(this),this.enter().append("svg:text").attr("fill",settings.labelColor).attr("transform",function(d){return"translate("+Math.cos((d.startAngle+d.endAngle-Math.PI)/2)*(settings.radius+settings.labelGroupOffset)+","+Math.sin((d.startAngle+d.endAngle-Math.PI)/2)*(settings.radius+settings.labelGroupOffset)+")"}),_position.call(this),this.transition().ease(settings.easeFunction).duration(settings.animationDuration).attrTween("transform",textTween),this.exit().remove(),this},donut=d3.layout.pie().value(function(data){return data[1]}),arc=d3.svg.arc().startAngle(function(d){return d.startAngle}).endAngle(function(d){return d.endAngle}).innerRadius(settings.innerRadius).outerRadius(settings.radius),chart=d3.select(selector).append("svg:svg").attr("class","donut-chart").attr("width",settings.width).attr("height",settings.height),path_group=chart.append("svg:g").attr("class","path-group").attr("transform","translate("+settings.width/2+","+settings.height/2+")"),label_group=chart.append("svg:g").attr("class","label-group").attr("transform","translate("+settings.width/2+","+settings.height/2+")");this.update=function(newData){_donutChart.totals=0;var paths,lines,valueLabels,nameLabels,filterData=function(element,index){return element.name=newData[index][0],element.value=newData[index][1],_donutChart.totals+=element.value,element.value>0};if(this.oldData=this.currentData,this.currentData=donut(newData).filter(filterData),this.currentData.length>0){var currentData=this.currentData;return paths=path_group.selectAll("path").data(currentData),paths.enter().append("svg:path").attr("stroke",settings.strokeColor).attr("stroke-width",settings.strokeWidth).attr("fill",function(d,i){return settings.colors(i)}).transition().ease(settings.easeFunction).duration(settings.animationDuration).attrTween("d",chartTween),paths.transition().ease(settings.easeFunction).duration(settings.animationDuration).attrTween("d",chartTween),paths.exit().transition().ease(settings.easeFunction).duration(settings.animationDuration).attrTween("d",removeChartTween).remove(),settings.enableLabels&&(lines=label_group.selectAll("line").data(currentData),lines.enter().append("svg:line").attr("x1",settings.tickOffset[0]).attr("x2",settings.tickOffset[1]).attr("y1",-settings.radius-settings.tickOffset[2]).attr("y2",-settings.radius-settings.tickOffset[3]).attr("stroke",settings.tickColor).attr("stroke-width",settings.tickWidth).attr("transform",function(d){return"rotate("+(d.startAngle+d.endAngle)/2*(180/Math.PI)+")"}),lines.transition().ease(settings.easeFunction).duration(settings.animationDuration).attr("transform",function(d){return"rotate("+(d.startAngle+d.endAngle)/2*(180/Math.PI)+")"}),lines.exit().remove(),nameLabels=label_group.selectAll("text.name").data(currentData),positionLabels.call(nameLabels,settings.labelNameOffset).attr("class","name").text(settings.labelNameText),valueLabels=label_group.selectAll("text.value").data(currentData),positionLabels.call(valueLabels,settings.labelValueOffset).attr("class","value").text(settings.labelValueText)),this}throw"No usable data"},data&&this.update(data)};